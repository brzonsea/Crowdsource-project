<!DOCTYPE html>
<html>

<head>
	<style>

	.button {
	    width: 10vh;
	    height: 5vh;
	    font-family: "Comic Sans MS";
	    background-color: #4CAF50;
	    color: white;
	    border: none;
	    border-radius: 8px;
	    cursor: pointer;
	    line-height: 0vh;
	    position: absolute;
	    bottom: 2vh;
	    right: 3vh;
	    z-index: 100;
	}
	.button:hover {
	    width: 10vh;
	    height: 5vh;
	    font-family: "Comic Sans MS";
	    background-color: #45a049;
	    color: white;
	    border: none;
	    border-radius: 8px;
	    cursor: pointer;
	    line-height: 0vh;
	    position: absolute;
	    bottom: 2vh;
	    right: 3vh;
	    z-index: 100;
	}

	.red {
	    width: 10vh;
	    height: 5vh;
	    font-family: "Comic Sans MS";
	    background-color: #cd1f1b;
	    color: white;
	    border: none;
	    border-radius: 8px;
	    cursor: pointer;
	    line-height: 0vh;
	    position: absolute;
	    bottom: 2vh;
	    right: 3vh;
	    z-index: 100;
	}
	.red:hover {
	    width: 10vh;
	    height: 5vh;
	    font-family: "Comic Sans MS";
	    background-color: #aa1916;
	    color: white;
	    border: none;
	    border-radius: 8px;
	    cursor: pointer;
	    line-height: 0vh;
	    position: absolute;
	    bottom: 2vh;
	    right: 3vh;
	    z-index: 100;
	}

	div.container {
		width: 100%;
		background: white;
		/*border: 1px solid gray;*/
	}

	div.layout {
		display: block;
		width: 100%;
		background: lightgray;
	}

	body {
		margin: 0;
		background: lightgray;
		font-size: large;
	}

	div.course {
		width: 10em;
		max-width: 10em;
		height: 7.5em;
		max-height: 7.5em;
		float: left;
		background: white;
		text-align: left;
		color: darkgray;
		font-size: xx-large;
		padding: 0.5em;
		margin-bottom: 1em;
		margin-left: 1em;
		margin-right: 1em;
		position: relative;
		z-index: 0;
		border-radius: 10px;
	}

	p {
		margin-top: 2em;
		margin-left: 1.2em;
		color: gray;
		font-size: 1.5em;
	}

	#login p {
		margin: 0em;
		margin-right: 1em;
		margin-top: 0.5em;
		color: gray;
		text-align: center;
		font-size: large;
	}

	#map_name p {
		font-size: 25px;
		margin: 0em;
	}

	span {
		display: inline-block;
		vertical-align: middle;
	}

	#plus img {
		margin: auto;
		display: block;
		margin: auto;
		position: absolute;
		top: 0; 
		left: 0; 
		bottom: 0; 
		right: 0;
	}

</style>
</head>



<body>

	<div class='container'>
		<header>
			<a href="course-overview.html">
				<img src="logo_0.1.png" alt = "Logo" width="150" style="margin: 0.25em">
				<div class='p' id='login' style="float: right;">
					<p>mikolez@kaist.ac.kr</p>
				</div>
			</a>
			<!-- <input id="image" type="image" src="https://raw.githubusercontent.com/brzonsea/Crowdsource-project/master/logo_0.1.png" width = "140" height = "35" margin-left = "10"> -->
		</header>
	</div>



	<p>My Maps</p>
	<div id="my_maps"></div>

	<p style="clear:both">Shared Maps</p>
	<div id="shared_maps"></div>


</body>

<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
<script type="text/javascript">
	window.onload = function() {
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCtsjLF75Sz-rqZapJHoj7WkfIrkI3bAmE",
			authDomain: "adipro-5bbe6.firebaseapp.com",
			databaseURL: "https://adipro-5bbe6.firebaseio.com",
			projectId: "adipro-5bbe6",
			storageBucket: "",
			messagingSenderId: "14626937593"
		};

		firebase.initializeApp(config);
		var database = firebase.database();
		var username = "testname";

		var loadMap = function() {
			//window.location = 'map-drawing-page.html?mapName=' + this.name + '&username=' + username;
		}

		function getValue(varname) {
			var url = window.location.href;
			var qparts = url.split("?");

			if (qparts.length == 1) {
				return "";
			} else {
			var query = qparts[1];
				var vars = query.split("&");
			var value = "";
			for (i = 0; i < vars.length; i++) {			
				var parts = vars[i].split("=");
				if (parts[0] == varname) {
					value = parts[1];
					break;
				}
			}
			value = unescape(value);

			// Convert "+"s to " "s
			value.replace(/\+/g, " ");
			return value;
			}
		}
		function addMap() {
        	var path = "accounts/" + this.username;
        	var mapref = database.ref(path);
        	mapref.push({name: this.mapname});
        	var tile = document.getElementById(this.mapname);
        	var shared_maps_div = document.getElementById("shared_maps");
        	var my_maps_div = document.getElementById("my_maps");
        	shared_maps_div.removeChild(tile);
        	my_maps_div.appendChild(tile);

        	var child = tile.childNodes[1];
	       	child.className = "red";
	       	child.innerHTML = "Leave";
	       	var nameContainer = {'mapname': tile.id, 'username': username};
			child.onclick = removeMap.bind(nameContainer);

        	var e = window.event;
    		e.cancelBubble = true;
    		e.stopPropagation();
        }

        function removeMap() {
        	var path = "accounts/" + this.username;
        	var mapref = database.ref(path);
        	var key;
        	var mapname = this.mapname;
        	var tile = document.getElementById(mapname);
	        var shared_maps_div = document.getElementById("shared_maps");
	       	var my_maps_div = document.getElementById("my_maps");
	       	my_maps_div.removeChild(tile);
	       	shared_maps_div.appendChild(tile);

	       	var child = tile.childNodes[1];
	       	child.className = "button";
	       	child.innerHTML = "Join";
	       	var nameContainer = {'mapname': tile.id, 'username': username};
			child.onclick = addMap.bind(nameContainer);


        	mapref.once("value", function(maps) {
        		maps.forEach(function(map) {
        			if (map.val().name == mapname) {
        				key = map.key;
        			}
        		});
        	}).then(function() {
        		path = path + "/" + key;
        		mapref = database.ref(path);
        		mapref.remove();
	        	var e = window.event;
	    		e.cancelBubble = true;
	    		e.stopPropagation();
	    	});
        }

		var my_maps = [];
		var shared_maps = [];
		function displayMapTiles(maptypediv, arraytype) {
			var shared_maps_div = document.getElementById(maptypediv);
			for (var i = 0; i < arraytype.length; i++) {
				var map_div = document.createElement('div');
				map_div.className = 'course';
				map_div.id = arraytype[i];
				map_div.innerHTML = arraytype[i].replace(/_/g, ' ');
				map_div.onclick = loadMap;
				shared_maps_div.appendChild(map_div);

				if (maptypediv == "shared_maps"){
					var map_join = document.createElement('button');
					map_join.className = 'button';
					map_div.appendChild(map_join);
					map_join.innerHTML = "Join";
					var nameContainer = {'mapname': arraytype[i], 'username': username};
					map_join.onclick = addMap.bind(nameContainer);
				} else {
					var map_leave = document.createElement('button');
					map_leave.className = 'red';
					map_div.appendChild(map_leave);
					map_leave.innerHTML = "Leave";
					var nameContainer = {'mapname': arraytype[i], 'username': username};
					map_leave.onclick = removeMap.bind(nameContainer);
				}
			}
		}

		function mine() {
			displayMapTiles('my_maps', my_maps);
		}

		function shared() {
			displayMapTiles('shared_maps', shared_maps);
		}


		//var username = getValue("username");
		
		var mymapref = database.ref("accounts/" + username);

		mymapref.once("value", function(maps) {
			maps.forEach(function(map) {
				my_maps.push(map.val().name);
			});
		}).then(mine);

		var mapref = database.ref("maps");
		mapref.once("value", function(maps) {
			maps.forEach(function(map) {
				if (!my_maps.includes(map.val().name)) {
					shared_maps.push(map.val().name);
				}
			});
		}).then(shared);

	}	
</script>
</html>

